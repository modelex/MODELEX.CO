"0","library(tidyverse) # for processing and plotting"
"0",""
"0","#' # Create the data"
"0","size = c(1.42,1.58,1.78,1.99,1.99,1.99,2.13,2.13,2.13,"
"0","         2.32,2.32,2.32,2.32,2.32,2.43,2.43,2.78,2.98,2.98)"
"0",""
"0","wear = c(4.0,4.2,2.5,2.6,2.8,2.4,3.2,2.4,2.6,4.8,2.9,"
"0","         3.8,3.0,2.7,3.1,3.3,3.0,2.8,1.7)"
"0",""
"0","x = size - min(size)"
"0","x = x / max(x)"
"0","d = data.frame(wear, x)"
"0",""
"0","#' Cubic spline function"
"0","rk <- function(x, z) {"
"0","  ((z-0.5)^2 - 1/12) * ((x-0.5)^2 - 1/12)/4 -"
"0","    ((abs(x-z)-0.5)^4 - (abs(x-z)-0.5)^2/2 + 7/240) / 24"
"0","}"
"0",""
"0","#' Generate the model matrix."
"0","splX <- function(x, knots) {"
"0","  q = length(knots) + 2                # number of parameters"
"0","  n = length(x)                        # number of observations"
"0","  X = matrix(1, n, q)                  # initialized model matrix"
"0","  X[ ,2]   = x                         # set second column to x"
"0","  X[ ,3:q] = outer(x, knots, FUN = rk) # remaining to cubic spline basis"
"0","  X"
"0","}"
"0",""
"0","splS <- function(knots) {"
"0","  q = length(knots) + 2"
"0","  S = matrix(0, q, q)                         # initialize matrix"
"0","  S[3:q, 3:q] = outer(knots, knots, FUN = rk) # fill in non-zero part"
"0","  S"
"0","}"
"0",""
"0","#' Matrix square root function. Note that there are various packages with their own."
"0","matSqrt <- function(S) {"
"0","  d  = eigen(S, symmetric = T)"
"0","  rS = d$vectors %*% diag(d$values^.5) %*% t(d$vectors)"
"0","  rS"
"0","}"
"0",""
"0","#' Penalized fitting function."
"0","prsFit <- function(y, x, knots, lambda) {"
"0","  q  = length(knots) + 2    # dimension of basis"
"0","  n  = length(x)            # number of observations"
"0","  Xa = rbind(splX(x, knots), matSqrt(splS(knots))*sqrt(lambda)) # augmented model matrix"
"0","  y[(n+1):(n+q)] = 0        # augment the data vector"
"0","  "
"0","  lm(y ~ Xa - 1) # fit and return penalized regression spline"
"0","}"
"0",""
"0",""
"0",""
"0","#' # Example 1"
"0",""
"0",""
"0","#' Unpenalized"
"0","#' "
"0","knots = 1:4/5"
"0","X = splX(x, knots)      # generate model matrix"
"0","mod1 = lm(wear ~ X - 1) # fit model"
"0",""
"0","xp = 0:100/100 # x values for prediction"
"0","Xp = splX(xp, knots) # prediction matrix"
"0",""
"0",""
"0","#' Visualize"
"0",""
"0","ggplot(aes(x = x, y = wear), data = data.frame(x, wear)) +"
"0","  geom_point(color = ""#FF5500"") +"
"0","  geom_line(aes(x = xp, y = Xp %*% coef(mod1)),"
"0","            data = data.frame(xp, Xp),"
"0","            color = ""#00AAFF"") +"
"0","  labs(x = 'Scaled Engine size', y  = 'Wear Index') +"
"0","  theme_minimal()"
